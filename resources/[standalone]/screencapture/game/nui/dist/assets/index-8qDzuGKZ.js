var A=Object.defineProperty;var T=t=>{throw TypeError(t)};var p=(t,e,r)=>e in t?A(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var h=(t,e,r)=>p(t,typeof e!="symbol"?e+"":e,r),m=(t,e,r)=>e.has(t)||T("Cannot "+r);var s=(t,e,r)=>(m(t,e,"read from private field"),r?r.call(t):e.get(t)),u=(t,e,r)=>e.has(t)?T("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,r),E=(t,e,r,i)=>(m(t,e,"write to private field"),i?i.call(t,r):e.set(t,r),r);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))i(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function r(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(a){if(a.ep)return;a.ep=!0;const o=r(a);fetch(a.href,o)}})();var w=`
  attribute vec2 a_position;
  attribute vec2 a_texcoord;
  uniform mat3 u_matrix;
  varying vec2 textureCoordinate;
  void main() {
    gl_Position = vec4(a_position, 0.0, 1.0);
    textureCoordinate = a_texcoord;
  }
`,x=`
varying highp vec2 textureCoordinate;
uniform sampler2D external_texture;
void main()
{
  gl_FragColor = texture2D(external_texture, textureCoordinate);
}
`;function R(t,e,r){let i=t.createShader(e);if(!i)throw new Error("Failed to create shader");t.shaderSource(i,r),t.compileShader(i);let a=t.getShaderInfoLog(i);return a&&console.error(a),i}function U(t){let e=t.createTexture(),r=new Uint8Array([0,0,255,255]);return t.bindTexture(t.TEXTURE_2D,e),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,r),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.MIRRORED_REPEAT),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.texParameterf(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),e}function b(t){let e=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,e),t.bufferData(t.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),t.STATIC_DRAW);let r=t.createBuffer();return t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,1,1]),t.STATIC_DRAW),{vertexBuff:e,texBuff:r}}function P(t){let e=R(t,t.VERTEX_SHADER,w),r=R(t,t.FRAGMENT_SHADER,x),i=t.createProgram();if(!i)throw new Error("Failed to create program");t.attachShader(i,e),t.attachShader(i,r),t.linkProgram(i),t.useProgram(i);let a=t.getAttribLocation(i,"a_position"),o=t.getAttribLocation(i,"a_texcoord");return{program:i,vloc:a,tloc:o}}function v(t){let e=t.getContext("webgl",{antialias:!1,depth:!1,stencil:!1,alpha:!1,desynchronized:!0,failIfMajorPerformanceCaveat:!1}),r=()=>{};function i(){let o=U(e),{program:n,vloc:c,tloc:d}=P(e),{vertexBuff:g,texBuff:_}=b(e);e.useProgram(n),e.bindTexture(e.TEXTURE_2D,o),e.uniform1i(e.getUniformLocation(n,"external_texture"),0),e.bindBuffer(e.ARRAY_BUFFER,g),e.vertexAttribPointer(c,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(c),e.bindBuffer(e.ARRAY_BUFFER,_),e.vertexAttribPointer(d,2,e.FLOAT,!1,0,0),e.enableVertexAttribArray(d),e.viewport(0,0,e.canvas.width,e.canvas.height),r()}let a={canvas:t,gl:e,animationFrame:void 0,resize:(o,n)=>{e.viewport(0,0,o,n),e.canvas.width=o,e.canvas.height=n}};return r=()=>{e.drawArrays(e.TRIANGLE_STRIP,0,4),e.finish(),a.animationFrame=requestAnimationFrame(r)},i(),a}var f,l;class y{constructor(){u(this,f);u(this,l,null);h(this,"MAX_WIDTH",1920);h(this,"MAX_HEIGHT",1080)}start(){window.addEventListener("message",async e=>{const r=e.data;r.action==="capture"&&await this.captureScreen(r)}),window.addEventListener("resize",()=>{s(this,f)&&s(this,f).resize(window.innerWidth,window.innerHeight)})}calculateDimensions(e){const r=window.innerWidth,i=window.innerHeight,a=e.maxWidth||this.MAX_WIDTH,o=e.maxHeight||this.MAX_HEIGHT;if(r<=a&&i<=o)return{width:r,height:i};const n=a/r,c=o/i,d=Math.min(n,c);return{width:Math.floor(r*d),height:Math.floor(i*d)}}async captureScreen(e){E(this,l,document.createElement("canvas"));const{width:r,height:i}=this.calculateDimensions(e);s(this,l).width=r,s(this,l).height=i,console.log(`Capturing at ${r}x${i} (original: ${window.innerWidth}x${window.innerHeight})`),E(this,f,v(s(this,l))),s(this,f).resize(r,i);const a=e.encoding??"png";let o;if(e.callbackUrl?o=await this.createDataURL(s(this,l),a,e.quality):o=await this.createBlob(s(this,l),a,e.quality),!o)return console.error("No image available");await this.httpUploadImage(e,o),s(this,l).remove()}async httpUploadImage(e,r){const i=this.createRequestBody(e,r);if(e.callbackUrl){try{await fetch(e.callbackUrl,{method:"POST",mode:"cors",body:i})}catch(a){console.error(a)}return}if(e.serverEndpoint)try{await fetch(e.serverEndpoint,{method:"POST",mode:"cors",headers:{"X-ScreenCapture-Token":e.uploadToken},body:i})}catch(a){console.error(a)}}createRequestBody(e,r){if(r instanceof Blob){const i=new FormData;return i.append("file",r),i}return JSON.stringify({data:r,id:e.correlationId})}createDataURL(e,r,i){return new Promise((a,o)=>{const n=e.toDataURL(`image/${r}`,i);n||o("No data URL available"),a(n)})}createBlob(e,r,i){return new Promise((a,o)=>{const n=e.width*e.height;let c=.7;i?c=i:n>2073600?c=.5:n>144e4&&(c=.6),console.log(`Using quality ${c} for ${e.width}x${e.height} (${n} pixels)`),e.toBlob(d=>{d?(console.log(`Generated blob: ${(d.size/1024/1024).toFixed(2)}MB`),a(d)):o("No blob available")},`image/${r}`,c)})}}f=new WeakMap,l=new WeakMap;const D=new y;D.start();
