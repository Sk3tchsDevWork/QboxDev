Aegis = Aegis or {}; Aegis.Duo = Aegis.Duo or { pending = {} } local function token() return ('%06d'):format(math.random(0,999999)) end function Aegis.Duo.Request(src,cap,pay) local t=token(); Aegis.Duo.pending[t]={requestedBy=src,capability=cap,payload=pay,ts=os.time()} return t end function Aegis.Duo.Approve(src,t) local p=Aegis.Duo.pending[t]; if not p then return false,'invalid token' end if p.requestedBy==src then return false,'self-approval not allowed' end local d=p; Aegis.Duo.pending[t]=nil; return true,d end function Aegis.Duo.List() local out={} for k,v in pairs(Aegis.Duo.pending) do out[#out+1]={token=k,capability=v.capability,requestedBy=v.requestedBy,ts=v.ts} end return out end